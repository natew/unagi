{
  "version": 3,
  "sources": ["../../../src/framework/middleware.ts"],
  "sourcesContent": ["import type { ServerResponse } from 'http'\n\nimport type { IncomingMessage, NextFunction } from 'connect'\nimport type { ViteDevServer } from 'vite'\n\nimport { RequestHandler } from './types.js'\n\ntype UnagiMiddlewareArgs = {\n  dev?: boolean\n  indexTemplate: string | ((url: string) => Promise<string>)\n  getServerEntrypoint: () => any\n  devServer?: ViteDevServer\n  cache?: Cache\n}\n\nlet entrypointError: Error | null = null\n\n/**\n * Provides middleware to Node.js Express-like servers. Used by the Unagi\n * Vite dev server plugin as well as production Node.js implementation.\n */\nexport function unagiMiddleware({\n  dev,\n  cache,\n  indexTemplate,\n  getServerEntrypoint,\n  devServer,\n}: UnagiMiddlewareArgs) {\n  if (dev && devServer) {\n    // Store this globally for devtools\n    // @ts-ignore\n    globalThis.__viteDevServer = devServer\n  }\n\n  /**\n   * We're running in the Node.js runtime without access to `fetch`,\n   * which is needed for proxy requests and server-side API requests.\n   */\n  const webPolyfills =\n    !globalThis.fetch || !globalThis.ReadableStream\n      ? import('../utilities/webPolyfill.js')\n      : undefined\n\n  return async function (request: IncomingMessage, response: ServerResponse, next: NextFunction) {\n    try {\n      await webPolyfills\n\n      const entrypoint = await Promise.resolve(getServerEntrypoint()).catch((error: Error) => {\n        // Errors are only thrown the first time we try to load the entry point.\n        // After refreshing the browser, this just loads an empty module\n        // and doesn't throw anymore. Store this error in the outer scope\n        // to keep throwing it on refresh until things are fixed.\n        entrypointError = error\n      })\n\n      const handleRequest: RequestHandler = entrypoint?.default ?? entrypoint\n\n      if (typeof handleRequest !== 'function') {\n        if (entrypointError) {\n          throw entrypointError\n        } else {\n          // This means there is no error when loading the entry point but\n          // we are still not getting a function as the default export.\n          throw new Error(\n            'Something is wrong in your project. Make sure to add \"export default renderUnagi(...)\" in your server entry file.'\n          )\n        }\n      }\n\n      entrypointError = null\n\n      await handleRequest(request, {\n        dev,\n        cache,\n        indexTemplate,\n        streamableResponse: response,\n      })\n    } catch (e: any) {\n      if (dev && devServer) devServer.ssrFixStacktrace(e)\n      response.statusCode = 500\n\n      /**\n       * Attempt to print the error stack within the template.\n       * This allows the react-refresh plugin and other Vite runtime helpers\n       * to display the error and auto-refresh when the error is fixed, instead\n       * of a white screen that needs a manual refresh.\n       */\n      try {\n        const template =\n          typeof indexTemplate === 'function'\n            ? await indexTemplate(request.originalUrl ?? request.url ?? '')\n            : indexTemplate\n        const html = template.replace(\n          `<div id=\"root\"></div>`,\n          `<div id=\"root\"><pre><code>${e.stack}</code></pre></div>`\n        )\n\n        response.write(html)\n        next(e)\n      } catch (_e) {\n        // If template loading is the culprit, give up and just return the error stack.\n        response.write(e.stack)\n        next(e)\n      }\n    }\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAeA,IAAI,kBAAgC;AAM7B,yBAAyB;AAAA,EAC9B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,GACsB;AACtB,MAAI,OAAO,WAAW;AAGpB,eAAW,kBAAkB;AAAA,EAC/B;AAMA,QAAM,eACJ,CAAC,WAAW,SAAS,CAAC,WAAW,iBAC7B,OAAO,iCACP;AAEN,SAAO,eAAgB,SAA0B,UAA0B,MAAoB;AAC7F,QAAI;AACF,YAAM;AAEN,YAAM,aAAa,MAAM,QAAQ,QAAQ,oBAAoB,CAAC,EAAE,MAAM,CAAC,UAAiB;AAKtF,0BAAkB;AAAA,MACpB,CAAC;AAED,YAAM,gBAAgC,0CAAY,YAAW;AAE7D,UAAI,OAAO,kBAAkB,YAAY;AACvC,YAAI,iBAAiB;AACnB,gBAAM;AAAA,QACR,OAAO;AAGL,gBAAM,IAAI,MACR,mHACF;AAAA,QACF;AAAA,MACF;AAEA,wBAAkB;AAElB,YAAM,cAAc,SAAS;AAAA,QAC3B;AAAA,QACA;AAAA,QACA;AAAA,QACA,oBAAoB;AAAA,MACtB,CAAC;AAAA,IACH,SAAS,GAAP;AACA,UAAI,OAAO;AAAW,kBAAU,iBAAiB,CAAC;AAClD,eAAS,aAAa;AAQtB,UAAI;AACF,cAAM,WACJ,OAAO,kBAAkB,aACrB,MAAM,cAAc,QAAQ,eAAe,QAAQ,OAAO,EAAE,IAC5D;AACN,cAAM,OAAO,SAAS,QACpB,yBACA,6BAA6B,EAAE,0BACjC;AAEA,iBAAS,MAAM,IAAI;AACnB,aAAK,CAAC;AAAA,MACR,SAAS,IAAP;AAEA,iBAAS,MAAM,EAAE,KAAK;AACtB,aAAK,CAAC;AAAA,MACR;AAAA,IACF;AAAA,EACF;AACF;",
  "names": []
}
