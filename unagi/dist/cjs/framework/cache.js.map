{
  "version": 3,
  "sources": ["../../../src/framework/cache.ts"],
  "sourcesContent": ["type CacheMatch = {\n  body: Uint8Array\n  timestamp: number\n  status: number\n  headers: [string, string][]\n}\n\n/**\n * This is a limited implementation of an in-memory cache.\n * It only supports the `cache-control` header.\n * It does NOT support `age` or `expires` headers.\n * @see https://developer.mozilla.org/en-US/docs/Web/API/Cache\n */\nexport class InMemoryCache implements Cache {\n  #store: Map<string, CacheMatch>\n\n  constructor() {\n    this.#store = new Map()\n  }\n\n  add(request: RequestInfo): Promise<void> {\n    throw new Error('Method not implemented. Use `put` instead.')\n  }\n\n  addAll(requests: RequestInfo[]): Promise<void> {\n    throw new Error('Method not implemented. Use `put` instead.')\n  }\n\n  matchAll(request?: RequestInfo, options?: CacheQueryOptions): Promise<readonly Response[]> {\n    throw new Error('Method not implemented. Use `match` instead.')\n  }\n\n  async put(request: Request, response: Response) {\n    if (request.method !== 'GET') {\n      throw new TypeError('Cannot cache response to non-GET request.')\n    }\n\n    if (response.status === 206) {\n      throw new TypeError('Cannot cache response to a range request (206 Partial Content).')\n    }\n\n    if (response.headers.get('vary')?.includes('*')) {\n      throw new TypeError(\"Cannot cache response with 'Vary: *' header.\")\n    }\n\n    this.#store.set(request.url, {\n      body: new Uint8Array(await response.arrayBuffer()),\n      status: response.status,\n      // @ts-ignore\n      headers: [...response.headers],\n      timestamp: Date.now(),\n    })\n  }\n\n  async match(request: Request) {\n    if (request.method !== 'GET') return\n\n    const match = this.#store.get(request.url)\n\n    if (!match) {\n      return\n    }\n\n    const { body, timestamp, ...metadata } = match\n\n    const headers = new Headers(metadata.headers)\n    const cacheControl = headers.get('cache-control') || ''\n    const maxAge = parseInt(cacheControl.match(/max-age=(\\d+)/)?.[1] || '0', 10)\n    const swr = parseInt(cacheControl.match(/stale-while-revalidate=(\\d+)/)?.[1] || '0', 10)\n    const age = (Date.now() - timestamp) / 1000\n\n    const isMiss = age > maxAge + swr\n    if (isMiss) {\n      this.#store.delete(request.url)\n      return\n    }\n\n    const isStale = age > maxAge\n\n    headers.set('cache', isStale ? 'STALE' : 'HIT')\n    headers.set('date', new Date(timestamp).toUTCString())\n\n    return new Response(body, {\n      status: metadata.status ?? 200,\n      headers,\n    })\n  }\n\n  async delete(request: Request) {\n    if (this.#store.has(request.url)) {\n      this.#store.delete(request.url)\n      return true\n    }\n    return false\n  }\n\n  keys(request?: Request) {\n    const cacheKeys = [] as Request[]\n\n    for (const url of this.#store.keys()) {\n      if (!request || request.url === url) {\n        cacheKeys.push(new Request(url))\n      }\n    }\n\n    return Promise.resolve(cacheKeys)\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAaO,MAAM,cAA+B;AAAA,EAG1C,cAAc;AAFd;AAGE,uBAAK,QAAS,oBAAI,IAAI;AAAA,EACxB;AAAA,EAEA,IAAI,SAAqC;AACvC,UAAM,IAAI,MAAM,4CAA4C;AAAA,EAC9D;AAAA,EAEA,OAAO,UAAwC;AAC7C,UAAM,IAAI,MAAM,4CAA4C;AAAA,EAC9D;AAAA,EAEA,SAAS,SAAuB,SAA2D;AACzF,UAAM,IAAI,MAAM,8CAA8C;AAAA,EAChE;AAAA,EAEA,MAAM,IAAI,SAAkB,UAAoB;AAhClD;AAiCI,QAAI,QAAQ,WAAW,OAAO;AAC5B,YAAM,IAAI,UAAU,2CAA2C;AAAA,IACjE;AAEA,QAAI,SAAS,WAAW,KAAK;AAC3B,YAAM,IAAI,UAAU,iEAAiE;AAAA,IACvF;AAEA,QAAI,eAAS,QAAQ,IAAI,MAAM,MAA3B,mBAA8B,SAAS,MAAM;AAC/C,YAAM,IAAI,UAAU,8CAA8C;AAAA,IACpE;AAEA,uBAAK,QAAO,IAAI,QAAQ,KAAK;AAAA,MAC3B,MAAM,IAAI,WAAW,MAAM,SAAS,YAAY,CAAC;AAAA,MACjD,QAAQ,SAAS;AAAA,MAEjB,SAAS,CAAC,GAAG,SAAS,OAAO;AAAA,MAC7B,WAAW,KAAK,IAAI;AAAA,IACtB,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,MAAM,SAAkB;AAtDhC;AAuDI,QAAI,QAAQ,WAAW;AAAO;AAE9B,UAAM,QAAQ,mBAAK,QAAO,IAAI,QAAQ,GAAG;AAEzC,QAAI,CAAC,OAAO;AACV;AAAA,IACF;AAEA,UAAM,EAAE,MAAM,cAAc,aAAa;AAEzC,UAAM,UAAU,IAAI,QAAQ,SAAS,OAAO;AAC5C,UAAM,eAAe,QAAQ,IAAI,eAAe,KAAK;AACrD,UAAM,SAAS,SAAS,oBAAa,MAAM,eAAe,MAAlC,mBAAsC,OAAM,KAAK,EAAE;AAC3E,UAAM,MAAM,SAAS,oBAAa,MAAM,8BAA8B,MAAjD,mBAAqD,OAAM,KAAK,EAAE;AACvF,UAAM,MAAO,MAAK,IAAI,IAAI,aAAa;AAEvC,UAAM,SAAS,MAAM,SAAS;AAC9B,QAAI,QAAQ;AACV,yBAAK,QAAO,OAAO,QAAQ,GAAG;AAC9B;AAAA,IACF;AAEA,UAAM,UAAU,MAAM;AAEtB,YAAQ,IAAI,SAAS,UAAU,UAAU,KAAK;AAC9C,YAAQ,IAAI,QAAQ,IAAI,KAAK,SAAS,EAAE,YAAY,CAAC;AAErD,WAAO,IAAI,SAAS,MAAM;AAAA,MACxB,QAAQ,SAAS,UAAU;AAAA,MAC3B;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,OAAO,SAAkB;AAC7B,QAAI,mBAAK,QAAO,IAAI,QAAQ,GAAG,GAAG;AAChC,yBAAK,QAAO,OAAO,QAAQ,GAAG;AAC9B,aAAO;AAAA,IACT;AACA,WAAO;AAAA,EACT;AAAA,EAEA,KAAK,SAAmB;AACtB,UAAM,YAAY,CAAC;AAEnB,eAAW,OAAO,mBAAK,QAAO,KAAK,GAAG;AACpC,UAAI,CAAC,WAAW,QAAQ,QAAQ,KAAK;AACnC,kBAAU,KAAK,IAAI,QAAQ,GAAG,CAAC;AAAA,MACjC;AAAA,IACF;AAEA,WAAO,QAAQ,QAAQ,SAAS;AAAA,EAClC;AACF;AA7FE;",
  "names": []
}
