{
  "version": 3,
  "sources": ["../../../../src/framework/plugins/middlewarePlugin.ts"],
  "sourcesContent": ["import { promises as fs } from 'fs'\nimport path from 'path'\n\nimport bodyParser from 'body-parser'\nimport { Plugin } from 'vite'\n\nimport { InMemoryCache } from '../cache.js'\nimport { unagiMiddleware } from '../middleware.js'\nimport { UNAGI_DEFAULT_SERVER_ENTRY } from './virtualFilesPlugin.js'\n\nexport default (pluginOptions: any) => {\n  return {\n    name: 'unagi:middleware',\n    /**\n     * By adding a middleware to the Vite dev server, we can handle SSR without needing\n     * a custom node script. It works by handling any requests for `text/html` documents,\n     * loading them in an SSR context, rendering them using the `entry-server` endpoint in the\n     * user's project, and injecting the static HTML into the template.\n     */\n    async configureServer(server) {\n      const resolve = (p: string) => path.resolve(server.config.root, p)\n      async function getIndexTemplate(url: string) {\n        const indexHtml = await fs.readFile(resolve('index.html'), 'utf-8')\n        return await server.transformIndexHtml(url, indexHtml)\n      }\n\n      server.middlewares.use(bodyParser.raw({ type: '*/*' }))\n\n      return () =>\n        server.middlewares.use(\n          unagiMiddleware({\n            dev: true,\n            indexTemplate: getIndexTemplate,\n            getServerEntrypoint: () => server.ssrLoadModule(UNAGI_DEFAULT_SERVER_ENTRY),\n            devServer: server,\n            cache: pluginOptions?.devCache ? (new InMemoryCache() as unknown as Cache) : undefined,\n          })\n        )\n    },\n  } as Plugin\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAA+B;AAC/B,kBAAiB;AAEjB,yBAAuB;AAGvB,mBAA8B;AAC9B,wBAAgC;AAChC,gCAA2C;AAE3C,IAAO,2BAAQ,CAAC,kBAAuB;AACrC,SAAO;AAAA,IACL,MAAM;AAAA,IAON,MAAM,gBAAgB,QAAQ;AAC5B,YAAM,UAAU,CAAC,MAAc,oBAAK,QAAQ,OAAO,OAAO,MAAM,CAAC;AACjE,sCAAgC,KAAa;AAC3C,cAAM,YAAY,MAAM,mBAAG,SAAS,QAAQ,YAAY,GAAG,OAAO;AAClE,eAAO,MAAM,OAAO,mBAAmB,KAAK,SAAS;AAAA,MACvD;AAEA,aAAO,YAAY,IAAI,2BAAW,IAAI,EAAE,MAAM,MAAM,CAAC,CAAC;AAEtD,aAAO,MACL,OAAO,YAAY,IACjB,uCAAgB;AAAA,QACd,KAAK;AAAA,QACL,eAAe;AAAA,QACf,qBAAqB,MAAM,OAAO,cAAc,oDAA0B;AAAA,QAC1E,WAAW;AAAA,QACX,OAAO,gDAAe,YAAY,IAAI,2BAAc,IAAyB;AAAA,MAC/E,CAAC,CACH;AAAA,IACJ;AAAA,EACF;AACF;",
  "names": []
}
